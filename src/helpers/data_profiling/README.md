## Data Profiling Process

This guide provides an overview of the data profiling scripts available in the `src/helpers/data_profiling` directory. These scripts analyze Excel files, extract metadata, and categorize them based on predefined or inferred schemas.

### Overview

The data profiling process involves two main scripts:

1. **`profile_excel_files.py`**: Analyzes Excel files to extract information such as schema, presence of charts, formulas, missing values, and generates a profile in JSON format.
2. **`profile_schema_category.py`**: Processes the generated JSON profiles and categorizes them according to predefined or dynamically inferred schemas.

### 1. `profile_excel_files.py`

This script analyzes all Excel files within a specified directory and its subdirectories, documenting various attributes, including:

- **Schema Information**: Lists columns, number of rows, and number of columns for each sheet.
- **Presence of Charts**: Detects if sheets contain charts (bar charts, line charts, pie charts, etc.).
- **Formulas**: Identifies cells with formulas and provides examples.
- **Missing Values**: Calculates the percentage of missing values for each column.
- **Sample Data**: Extracts a sample set of data for inspection.

#### How to Use

To analyze Excel files and create JSON profiles, use the following example code:

```python
from src.helpers.data_profiling.profile_excel_files import profile_excel_files

# Define the path to your Excel files
directory_path = "/path/to/excel/files"
output_folder = "output"  # Specify the folder to save JSON profiles
exclude_folders = []  # List of subfolders to exclude from profiling

# Run the profiling function
profile_excel_files(directory_path, output_folder=output_folder, exclude_folders=exclude_folders)
```

This code will process all Excel files in the specified directory (and its subdirectories) and save the profiling results as JSON files in the specified output folder.

### 2. `profile_schema_category.py`

This script analyzes the JSON profiles created by `profile_excel_files.py` and categorizes them based on either predefined schemas or dynamically inferred schemas.

#### Key Functionalities

- **Schema Matching**: Compares the Excel file profiles against a set of schemas.
- **Categorization**: Groups files into categories (e.g., exact match, extended match, partial match, or no match).
- **Filtering**: Excludes specific sheets or file combinations from the analysis.

#### How to Use

To categorize the JSON profiles based on predefined or inferred schemas, use the following example code:

```python
from src.helpers.data_profiling.profile_schema_category import main as categorize_files_main

# Define paths for schema categorization
json_files_path = "output"  # Path to the folder containing JSON profiles
schemas_path = "path/to/schemas.json"  # Path to predefined schemas (optional)
output_path = "output_directory"  # Output directory for categorized files
filename = "filename"  # Base name for the output file
out_scope_sheetnames = ['Sheet1', 'Sheet2']  # Optional list of sheets to exclude

# Run the schema categorization
categorize_files_main(json_files_path, output_path, filename, schemas_path, out_scope_sheetnames)
```

### Additional Information

- **Schemas**: If no schemas are provided, they are inferred from the input data. If predefined schemas are available, they should be provided in JSON format.
- **Output Directory**: All categorized files are saved in the specified output directory.
- **Dependencies**: Ensure you have installed the necessary Python packages like `pandas`, `openpyxl`, and `json`.

### Example Outputs

The following are examples of the JSON outputs generated by the scripts:

#### Profile Example (`profile_excel_files.py`):

```json
{
    "filepath": "/path/to/excel/file.xlsx",
    "Sheet1": {
        "charts": false,
        "contains_formulas": true,
        "columns_with_formulas": {
            "C": "=C3-(3/5280)"
        },
        "columns": ["Column1", "Column2", "Column3"],
        "num_rows": 1000,
        "num_columns": 3,
        "missing_values_percentage": {
            "Column1": 0.0,
            "Column2": 0.1,
            "Column3": 0.05
        },
        "sample_data": [
            {"Column1": "Value1", "Column2": "Value2", "Column3": "Value3"},
            {"Column1": "Value4", "Column2": "Value5", "Column3": "Value6"}
        ]
    }
}
```

#### Categorization Example (`profile_schema_category.py`):

```json
{
    "exact_match_groups": {
        "Schema A": [
            ["/path/to/file1.xlsx", "Sheet1", 1.0],
            ["/path/to/file2.xlsx", "Sheet2", 1.0]
        ]
    },
    "extended_match_groups": {},
    "partial_match_groups": {
        "Schema B": [
            ["/path/to/file3.xlsx", "Sheet1", 2, 0.9]
        ]
    },
    "no_match_sheets": {
        "file4.xlsx": ["Sheet3"]
    },
    "out_scope_sheets": {}
}
```

### Suggested Workflow for Schema Definition

After running the profiling scripts, review the generated JSON files to identify common patterns and structures in your data. Use this analysis to define meaningful schemas that represent different data definitions across your Excel files.

These schemas should be manually named and defined, then saved in JSON format. Use this schema file as the `schemas_path` argument in your categorization script to categorize files based on these predefined schemas.

#### Example Schema Definition

Referencing the example format provided earlier:

```json
{
    "Base Schema 1": [
        "Attribute A",
        "Attribute B",
    ],
    "Variation 1A": [
        "Attribute A",
        "Attribute B",
        "Attribute C",
        "Attribute D",
    ],
    "Variation 1B": [
        "Attribute A",
        "Attribute B",
        "Attribute F",
        "Attribute G",
    ]
}
```

### Summary

By defining schemas and categorizing files, you gain a structured overview of your data. The outputs provide essential insights into the data's structure, allowing you to tailor custom schemas for consistent categorization. This process may need further refinement based on your data's complexity and specific project objectives.

### References

- [Pandas Documentation](https://pandas.pydata.org/)
- [OpenPyXL Documentation](https://openpyxl.readthedocs.io/)
